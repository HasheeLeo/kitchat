{"dependencies":[{"name":"@babel/runtime/helpers/interopRequireDefault","data":{"isAsync":false}},{"name":"@babel/runtime/regenerator","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/classCallCheck","data":{"isAsync":false}},{"name":"@babel/runtime/helpers/createClass","data":{"isAsync":false}},{"name":"axios","data":{"isAsync":false}},{"name":"./SessionFactory","data":{"isAsync":false}},{"name":"../constants","data":{"isAsync":false}}],"output":[{"data":{"code":"__d(function (global, _$$_REQUIRE, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  var _interopRequireDefault = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\");\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = void 0;\n\n  var _regenerator = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[1], \"@babel/runtime/regenerator\"));\n\n  var _classCallCheck2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[2], \"@babel/runtime/helpers/classCallCheck\"));\n\n  var _createClass2 = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[3], \"@babel/runtime/helpers/createClass\"));\n\n  var _axios = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[4], \"axios\"));\n\n  var _SessionFactory = _interopRequireDefault(_$$_REQUIRE(_dependencyMap[5], \"./SessionFactory\"));\n\n  var _constants = _$$_REQUIRE(_dependencyMap[6], \"../constants\");\n\n  var MessageApi = function () {\n    function MessageApi() {\n      (0, _classCallCheck2.default)(this, MessageApi);\n    }\n\n    (0, _createClass2.default)(MessageApi, null, [{\n      key: \"GCMessageToMessage\",\n      value: function GCMessageToMessage(receiverId, gcMessage, attachment) {\n        return {\n          id: gcMessage._id,\n          isVoice: false,\n          text: gcMessage.text,\n          isFile: attachment ? true : false,\n          fileName: attachment ? attachment.fileName : \"null\",\n          fileType: attachment ? attachment.fileType : \"null\",\n          createdAt: gcMessage.createdAt,\n          senderId: gcMessage.user._id,\n          receiverId: receiverId,\n          groupId: \"null\"\n        };\n      }\n    }, {\n      key: \"MessageToGCMessage\",\n      value: function MessageToGCMessage(message) {\n        return {\n          _id: message.id,\n          voice: message.isVoice,\n          text: message.text ? message.text : '',\n          createdAt: message.createdAt,\n          user: {\n            _id: message.senderId\n          }\n        };\n      }\n    }, {\n      key: \"listen\",\n      value: function listen(callback) {\n        if (MessageApi.globallyRegistered) return;\n        MessageApi.globallyRegistered = true;\n\n        var session = _SessionFactory.default.getSession();\n\n        var unsubscribe = session.subscribe(_constants.Event.message, function _callee(data) {\n          var message;\n          return _regenerator.default.async(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  message = JSON.parse(data);\n\n                  if (!(MessageApi.conversationId && message.senderId === MessageApi.conversationId)) {\n                    _context.next = 3;\n                    break;\n                  }\n\n                  return _context.abrupt(\"return\");\n\n                case 3:\n                  MessageApi.subscribeCallback(callback, message);\n\n                case 4:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          });\n        });\n        return function () {\n          MessageApi.globallyRegistered = false;\n          unsubscribe();\n        };\n      }\n    }, {\n      key: \"listenToId\",\n      value: function listenToId(callback, senderId) {\n        MessageApi.conversationId = senderId;\n\n        var session = _SessionFactory.default.getSession();\n\n        var unsubscribe = session.subscribe(_constants.Event.message, function _callee2(data) {\n          var message;\n          return _regenerator.default.async(function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  message = JSON.parse(data);\n\n                  if (!(MessageApi.conversationId && MessageApi.conversationId !== message.senderId)) {\n                    _context2.next = 3;\n                    break;\n                  }\n\n                  return _context2.abrupt(\"return\");\n\n                case 3:\n                  MessageApi.subscribeCallback(callback, message);\n\n                case 4:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          });\n        });\n        return function () {\n          MessageApi.conversationId = null;\n          unsubscribe();\n        };\n      }\n    }, {\n      key: \"requestAttachment\",\n      value: function requestAttachment(id) {\n        var response;\n        return _regenerator.default.async(function requestAttachment$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n                _context3.next = 3;\n                return _regenerator.default.awrap(_axios.default.get(\"http://\" + _constants.SERVER_IP + \"/files/\" + id));\n\n              case 3:\n                response = _context3.sent;\n                return _context3.abrupt(\"return\", response.data.chatMessageAttachedFile);\n\n              case 7:\n                _context3.prev = 7;\n                _context3.t0 = _context3[\"catch\"](0);\n                console.log(_context3.t0);\n\n              case 10:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, null, null, [[0, 7]]);\n      }\n    }, {\n      key: \"sendAttachment\",\n      value: function sendAttachment(id, attachment) {\n        try {\n          _axios.default.post(\"http://\" + _constants.SERVER_IP + \"/files\", {\n            chatMessageAttachmentId: id,\n            chatMessageAttachedFile: attachment.file\n          });\n        } catch (e) {\n          console.log(e);\n        }\n      }\n    }, {\n      key: \"sendMessage\",\n      value: function sendMessage(receiverId, gcMessage, attachment) {\n        var message = MessageApi.GCMessageToMessage(receiverId, gcMessage, attachment);\n\n        var session = _SessionFactory.default.getSession();\n\n        session.sendData(JSON.stringify(message));\n        if (attachment) MessageApi.sendAttachment(message.id, attachment);\n      }\n    }, {\n      key: \"subscribeCallback\",\n      value: function subscribeCallback(callback, message) {\n        var gcMessage, file, _attachment;\n\n        return _regenerator.default.async(function subscribeCallback$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                gcMessage = MessageApi.MessageToGCMessage(message);\n\n                if (!(message.isFile && message.fileName)) {\n                  _context4.next = 8;\n                  break;\n                }\n\n                _context4.next = 4;\n                return _regenerator.default.awrap(MessageApi.requestAttachment(message.id));\n\n              case 4:\n                file = _context4.sent;\n\n                if (file) {\n                  _attachment = {\n                    file: file,\n                    fileName: message.fileName,\n                    fileType: message.fileType\n                  };\n                  callback(gcMessage, _attachment);\n                }\n\n                _context4.next = 9;\n                break;\n\n              case 8:\n                callback(gcMessage);\n\n              case 9:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        });\n      }\n    }]);\n    return MessageApi;\n  }();\n\n  var _default = MessageApi;\n  exports.default = _default;\n});","lineCount":230,"map":[[15,0,3,0],[17,0,5,0],[19,0,6,0],[21,6,18,6,"MessageApi"],[21,16],[28,41,26,28,"receiverId"],[28,51],[28,53,26,48,"gcMessage"],[28,62],[28,64,27,4,"attachment"],[28,74],[28,76,28,2],[29,0,29,4],[29,15,29,11],[30,0,30,6,"id"],[30,10,30,6,"id"],[30,12,30,8],[30,14,30,10,"gcMessage"],[30,23,30,19],[30,24,30,20,"_id"],[30,27,29,11],[31,0,31,6,"isVoice"],[31,10,31,6,"isVoice"],[31,17,31,13],[31,19,31,15],[31,24,29,11],[32,0,32,6,"text"],[32,10,32,6,"text"],[32,14,32,10],[32,16,32,12,"gcMessage"],[32,25,32,21],[32,26,32,22,"text"],[32,30,29,11],[33,0,33,6,"isFile"],[33,10,33,6,"isFile"],[33,16,33,12],[33,18,33,14,"attachment"],[33,28,33,24],[33,31,33,27],[33,35,33,24],[33,38,33,34],[33,43,29,11],[34,0,34,6,"fileName"],[34,10,34,6,"fileName"],[34,18,34,14],[34,20,34,16,"attachment"],[34,30,34,26],[34,33,34,29,"attachment"],[34,43,34,39],[34,44,34,40,"fileName"],[34,52,34,26],[34,55,34,51],[34,61,29,11],[35,0,35,6,"fileType"],[35,10,35,6,"fileType"],[35,18,35,14],[35,20,35,16,"attachment"],[35,30,35,26],[35,33,35,29,"attachment"],[35,43,35,39],[35,44,35,40,"fileType"],[35,52,35,26],[35,55,35,51],[35,61,29,11],[36,0,36,6,"createdAt"],[36,10,36,6,"createdAt"],[36,19,36,15],[36,21,36,17,"gcMessage"],[36,30,36,26],[36,31,36,27,"createdAt"],[36,40,29,11],[37,0,37,6,"senderId"],[37,10,37,6,"senderId"],[37,18,37,14],[37,20,37,16,"gcMessage"],[37,29,37,25],[37,30,37,26,"user"],[37,34,37,16],[37,35,37,31,"_id"],[37,38,29,11],[38,0,38,6,"receiverId"],[38,10,38,6,"receiverId"],[38,20,38,16],[38,22,38,18,"receiverId"],[38,32,29,11],[39,0,39,6,"groupId"],[39,10,39,6,"groupId"],[39,17,39,13],[39,19,39,15],[40,0,29,11],[40,9,29,4],[41,0,41,3],[44,41,43,28,"message"],[44,48],[44,50,43,52],[45,0,44,4],[45,15,44,11],[46,0,45,6,"_id"],[46,10,45,6,"_id"],[46,13,45,9],[46,15,45,11,"message"],[46,22,45,18],[46,23,45,19,"id"],[46,25,44,11],[47,0,46,6,"voice"],[47,10,46,6,"voice"],[47,15,46,11],[47,17,46,13,"message"],[47,24,46,20],[47,25,46,21,"isVoice"],[47,32,44,11],[48,0,47,6,"text"],[48,10,47,6,"text"],[48,14,47,10],[48,16,47,12,"message"],[48,23,47,19],[48,24,47,20,"text"],[48,28,47,12],[48,31,47,27,"message"],[48,38,47,34],[48,39,47,35,"text"],[48,43,47,12],[48,46,47,42],[48,48,44,11],[49,0,48,6,"createdAt"],[49,10,48,6,"createdAt"],[49,19,48,15],[49,21,48,17,"message"],[49,28,48,24],[49,29,48,25,"createdAt"],[49,38,44,11],[50,0,49,6,"user"],[50,10,49,6,"user"],[50,14,49,10],[50,16,49,12],[51,0,49,13,"_id"],[51,12,49,13,"_id"],[51,15,49,16],[51,17,49,18,"message"],[51,24,49,25],[51,25,49,26,"senderId"],[52,0,49,12],[53,0,44,11],[53,9,44,4],[54,0,51,3],[57,29,53,16,"callback"],[57,37],[57,39,53,42],[58,0,54,4],[58,12,54,8,"MessageApi"],[58,22,54,18],[58,23,54,19,"globallyRegistered"],[58,41,54,4],[58,43,55,6],[59,0,57,4,"MessageApi"],[59,8,57,4,"MessageApi"],[59,18,57,14],[59,19,57,15,"globallyRegistered"],[59,37,57,4],[59,40,57,36],[59,44,57,4],[61,0,58,4],[61,12,58,10,"session"],[61,19,58,17],[61,22,58,20,"SessionFactory"],[61,46,58,35,"getSession"],[61,56,58,20],[61,58,58,4],[63,0,59,4],[63,12,59,10,"unsubscribe"],[63,23,59,21],[63,26,59,24,"session"],[63,33,59,31],[63,34,59,32,"subscribe"],[63,43,59,24],[63,44,59,42,"Event"],[63,61,59,48,"message"],[63,68,59,24],[63,70,59,57],[63,87,59,63,"data"],[63,91,59,57],[64,0,59,57],[65,0,59,57],[66,0,59,57],[67,0,59,57],[68,0,59,57],[69,0,60,12,"message"],[69,18,60,12,"message"],[69,25,59,57],[69,28,60,37,"JSON"],[69,32,60,41],[69,33,60,42,"parse"],[69,38,60,37],[69,39,60,48,"data"],[69,43,60,37],[69,44,59,57],[71,0,59,57],[71,24,63,10,"MessageApi"],[71,34,63,20],[71,35,63,21,"conversationId"],[71,49,63,10],[71,53,64,13,"message"],[71,60,64,20],[71,61,64,21,"senderId"],[71,69,64,13],[71,74,64,34,"MessageApi"],[71,84,64,44],[71,85,64,45,"conversationId"],[71,99,59,57],[72,0,59,57],[73,0,59,57],[74,0,59,57],[76,0,59,57],[78,0,59,57],[79,0,67,6,"MessageApi"],[79,18,67,6,"MessageApi"],[79,28,67,16],[79,29,67,17,"subscribeCallback"],[79,46,67,6],[79,47,67,35,"callback"],[79,55,67,6],[79,57,67,45,"message"],[79,64,67,6],[81,0,59,57],[82,0,59,57],[83,0,59,57],[84,0,59,57],[85,0,59,57],[86,0,59,57],[87,0,59,57],[87,9,59,24],[87,10,59,4],[88,0,70,4],[88,15,70,11],[88,27,70,17],[89,0,71,6,"MessageApi"],[89,10,71,6,"MessageApi"],[89,20,71,16],[89,21,71,17,"globallyRegistered"],[89,39,71,6],[89,42,71,38],[89,47,71,6],[90,0,72,6,"unsubscribe"],[90,10,72,6,"unsubscribe"],[90,21,72,17],[91,0,73,5],[91,9,70,4],[92,0,74,3],[95,33,76,20,"callback"],[95,41],[95,43,76,46,"senderId"],[95,51],[95,53,76,64],[96,0,77,4,"MessageApi"],[96,8,77,4,"MessageApi"],[96,18,77,14],[96,19,77,15,"conversationId"],[96,33,77,4],[96,36,77,32,"senderId"],[96,44,77,4],[98,0,78,4],[98,12,78,10,"session"],[98,19,78,17],[98,22,78,20,"SessionFactory"],[98,46,78,35,"getSession"],[98,56,78,20],[98,58,78,4],[100,0,79,4],[100,12,79,10,"unsubscribe"],[100,23,79,21],[100,26,79,24,"session"],[100,33,79,31],[100,34,79,32,"subscribe"],[100,43,79,24],[100,44,79,42,"Event"],[100,61,79,48,"message"],[100,68,79,24],[100,70,79,57],[100,88,79,63,"data"],[100,92,79,57],[101,0,79,57],[102,0,79,57],[103,0,79,57],[104,0,79,57],[105,0,79,57],[106,0,80,12,"message"],[106,18,80,12,"message"],[106,25,79,57],[106,28,80,37,"JSON"],[106,32,80,41],[106,33,80,42,"parse"],[106,38,80,37],[106,39,80,48,"data"],[106,43,80,37],[106,44,79,57],[108,0,79,57],[108,24,81,10,"MessageApi"],[108,34,81,20],[108,35,81,21,"conversationId"],[108,49,81,10],[108,53,82,13,"MessageApi"],[108,63,82,23],[108,64,82,24,"conversationId"],[108,78,82,13],[108,83,82,43,"message"],[108,90,82,50],[108,91,82,51,"senderId"],[108,99,79,57],[109,0,79,57],[110,0,79,57],[111,0,79,57],[113,0,79,57],[115,0,79,57],[116,0,85,6,"MessageApi"],[116,18,85,6,"MessageApi"],[116,28,85,16],[116,29,85,17,"subscribeCallback"],[116,46,85,6],[116,47,85,35,"callback"],[116,55,85,6],[116,57,85,45,"message"],[116,64,85,6],[118,0,79,57],[119,0,79,57],[120,0,79,57],[121,0,79,57],[122,0,79,57],[123,0,79,57],[124,0,79,57],[124,9,79,24],[124,10,79,4],[125,0,88,4],[125,15,88,11],[125,27,88,17],[126,0,89,6,"MessageApi"],[126,10,89,6,"MessageApi"],[126,20,89,16],[126,21,89,17,"conversationId"],[126,35,89,6],[126,38,89,34],[126,42,89,6],[127,0,90,6,"unsubscribe"],[127,10,90,6,"unsubscribe"],[127,21,90,17],[128,0,91,5],[128,9,88,4],[129,0,92,3],[132,40,94,33,"id"],[132,42],[140,50,96,29,"axios"],[140,65,96,35,"get"],[140,68,96,29],[140,81,96,49,"SERVER_IP"],[140,101,96,29],[140,116,96,68,"id"],[140,118,96,29],[140,119],[143,0,96,12,"response"],[143,16,96,12,"response"],[143,24],[144,50,97,13,"response"],[144,58,97,21],[144,59,97,22,"data"],[144,63,97,13],[144,64,97,27,"chatMessageAttachedFile"],[144,87],[149,0,100,6,"console"],[149,16,100,6,"console"],[149,23,100,13],[149,24,100,14,"log"],[149,27,100,6],[160,37,104,24,"id"],[160,39],[160,41,104,36,"attachment"],[160,51],[160,53,104,60],[161,0,105,4],[161,12,105,8],[162,0,106,6,"axios"],[162,25,106,12,"post"],[162,29,106,6],[162,42,106,27,"SERVER_IP"],[162,62,106,6],[162,75,106,46],[163,0,107,8,"chatMessageAttachmentId"],[163,12,107,8,"chatMessageAttachmentId"],[163,35,107,31],[163,37,107,33,"id"],[163,39,106,46],[164,0,108,8,"chatMessageAttachedFile"],[164,12,108,8,"chatMessageAttachedFile"],[164,35,108,31],[164,37,108,33,"attachment"],[164,47,108,43],[164,48,108,44,"file"],[165,0,106,46],[165,11,106,6],[166,0,110,5],[166,9,105,4],[166,10,111,4],[166,17,111,11,"e"],[166,18,111,4],[166,20,111,14],[167,0,112,6,"console"],[167,10,112,6,"console"],[167,17,112,13],[167,18,112,14,"log"],[167,21,112,6],[167,22,112,18,"e"],[167,23,112,6],[168,0,113,5],[169,0,114,3],[172,34,116,21,"receiverId"],[172,44],[172,46,116,41,"gcMessage"],[172,55],[172,57,117,4,"attachment"],[172,67],[172,69,118,2],[173,0,119,4],[173,12,119,10,"message"],[173,19,119,17],[173,22,119,20,"MessageApi"],[173,32,119,30],[173,33,119,31,"GCMessageToMessage"],[173,51,119,20],[173,52,119,50,"receiverId"],[173,62,119,20],[173,64,119,62,"gcMessage"],[173,73,119,20],[173,75,120,6,"attachment"],[173,85,119,20],[173,86,119,4],[175,0,121,4],[175,12,121,10,"session"],[175,19,121,17],[175,22,121,20,"SessionFactory"],[175,46,121,35,"getSession"],[175,56,121,20],[175,58,121,4],[177,0,122,4,"session"],[177,8,122,4,"session"],[177,15,122,11],[177,16,122,12,"sendData"],[177,24,122,4],[177,25,122,21,"JSON"],[177,29,122,25],[177,30,122,26,"stringify"],[177,39,122,21],[177,40,122,36,"message"],[177,47,122,21],[177,48,122,4],[178,0,124,4],[178,12,124,8,"attachment"],[178,22,124,4],[178,24,125,6,"MessageApi"],[178,34,125,16],[178,35,125,17,"sendAttachment"],[178,49,125,6],[178,50,125,32,"message"],[178,57,125,39],[178,58,125,40,"id"],[178,60,125,6],[178,62,125,44,"attachment"],[178,72,125,6],[179,0,126,3],[182,40,128,33,"callback"],[182,48],[182,50,129,4,"message"],[182,57],[189,0,131,10,"gcMessage"],[189,16,131,10,"gcMessage"],[189,25],[189,28,131,22,"MessageApi"],[189,38,131,32],[189,39,131,33,"MessageToGCMessage"],[189,57,131,22],[189,58,131,52,"message"],[189,65,131,22],[189,66],[191,22,132,8,"message"],[191,29,132,15],[191,30,132,16,"isFile"],[191,36,132,8],[191,40,132,26,"message"],[191,47,132,33],[191,48,132,34,"fileName"],[191,56],[197,50,133,25,"MessageApi"],[197,60,133,35],[197,61,133,36,"requestAttachment"],[197,78,133,25],[197,79,133,54,"message"],[197,86,133,61],[197,87,133,62,"id"],[197,89,133,25],[197,90],[200,0,133,12,"file"],[200,16,133,12,"file"],[200,20],[202,0,134,6],[202,20,134,10,"file"],[202,24,134,6],[202,26,134,16],[203,0,135,14,"attachment"],[203,18,135,14,"attachment"],[203,29,134,16],[203,32,135,27],[204,0,136,10,"file"],[204,20,136,10,"file"],[204,24,136,14],[204,26,136,16,"file"],[204,30,135,27],[205,0,137,10,"fileName"],[205,20,137,10,"fileName"],[205,28,137,18],[205,30,137,20,"message"],[205,37,137,27],[205,38,137,28,"fileName"],[205,46,135,27],[206,0,138,10,"fileType"],[206,20,138,10,"fileType"],[206,28,138,18],[206,30,138,20,"message"],[206,37,138,27],[206,38,138,28,"fileType"],[207,0,135,27],[207,19,134,16],[208,0,140,8,"callback"],[208,18,140,8,"callback"],[208,26,140,16],[208,27,140,17,"gcMessage"],[208,36,140,16],[208,38,140,28,"attachment"],[208,49,140,16],[208,50,140,8],[209,0,141,7],[215,0,144,6,"callback"],[215,16,144,6,"callback"],[215,24,144,14],[215,25,144,15,"gcMessage"],[215,34,144,14],[215,35,144,6],[228,17,149,15,"MessageApi"],[228,27]],"functionMap":{"names":["<global>","MessageApi","GCMessageToMessage","MessageToGCMessage","listen","session.subscribe$argument_1","<anonymous>","listenToId","requestAttachment","sendAttachment","sendMessage","subscribeCallback"],"mappings":"AAA;ACiB;ECQ;GDe;EEE;GFQ;EGE;yDCM;KDS;WEE;KFG;GHC;EME;yDFG;KEO;WDE;KCG;GNC;EOE;GPQ;EQE;GRU;ESE;GTU;EUE;GVkB;CDC"}},"type":"js/module"}]}